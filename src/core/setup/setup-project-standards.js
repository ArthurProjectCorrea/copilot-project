#!/usr/bin/env node

/**
 * Script unificado para configura√ß√£o de padroniza√ß√£o de projetos
 * Respons√°vel por: Husky, Commitlint, Prettier, ESLint, Changesets, Commitizen
 */

const { execSync } = require('child_process');
const { writeFileSync, readFileSync, existsSync, mkdirSync } = require('fs');
const { join } = require('path');
const readline = require('readline');

class ProjectStandardsInstaller {
  constructor() {
    this.rootDir = process.cwd();
    this.packageManager = this.detectPackageManager();
    this.framework = this.detectFramework();
    this.isTypeScript = this.hasTypeScript();

    console.log('üöÄ Configurador de Padroniza√ß√£o de Projetos');
    console.log('==========================================\n');
    console.log(`üìÅ Diret√≥rio: ${this.rootDir}`);
    console.log(`üì¶ Package Manager: ${this.packageManager}`);
    console.log(`üîß Framework: ${this.framework}`);
    console.log(`üìò TypeScript: ${this.isTypeScript ? 'Sim' : 'N√£o'}\n`);
  }

  detectPackageManager() {
    if (existsSync('pnpm-lock.yaml')) return 'pnpm';
    if (existsSync('yarn.lock')) return 'yarn';
    if (existsSync('package-lock.json')) return 'npm';
    return 'npm';
  }

  detectFramework() {
    if (existsSync('nest-cli.json')) return 'nestjs';
    if (
      existsSync('next.config.js') ||
      existsSync('next.config.mjs') ||
      existsSync('next.config.ts')
    )
      return 'nextjs';
    if (existsSync('nuxt.config.js') || existsSync('nuxt.config.ts')) return 'nuxtjs';
    if (existsSync('vite.config.js') || existsSync('vite.config.ts')) return 'vite';
    if (existsSync('webpack.config.js')) return 'webpack';
    return 'node';
  }

  hasTypeScript() {
    return existsSync('tsconfig.json');
  }

  async install() {
    try {
      await this.promptUser();
      await this.installDependencies();
      await this.setupHusky();
      await this.createConfigFiles();
      await this.updatePackageJson();
      await this.setupChangesets();
      await this.installCopilotProject();
      await this.showCompletionMessage();
    } catch (error) {
      console.error('‚ùå Erro durante a configura√ß√£o:', error);
      process.exit(1);
    }
  }

  async promptUser() {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout,
    });

    return new Promise((resolve) => {
      rl.question('üîß Deseja continuar com a configura√ß√£o? (y/n): ', (answer) => {
        rl.close();
        if (answer.toLowerCase() !== 'y' && answer.toLowerCase() !== 'yes') {
          console.log('‚ùå Configura√ß√£o cancelada.');
          process.exit(0);
        }
        resolve(true);
      });
    });
  }

  async installDependencies() {
    console.log('üì¶ Instalando depend√™ncias de desenvolvimento...');

    const devDependencies = [
      // Husky e Lint-staged
      'husky@^9.1.7',
      'lint-staged@^16.1.6',

      // CommitLint
      '@commitlint/cli@^19.8.1',
      '@commitlint/config-conventional@^19.8.1',

      // Commitizen
      'commitizen@^4.3.1',
      'cz-conventional-changelog@^3.3.0',

      // Changesets
      '@changesets/cli@^2.29.6',

      // Prettier
      'prettier@^3.6.2',

      // ESLint
      'eslint@^9.34.0',
      'eslint-config-prettier@^10.1.8',
      'eslint-plugin-prettier@^5.5.4',
      'eslint-plugin-security@^3.0.1',
      '@eslint/js@^9.34.0',
      'globals@^16.3.0',
    ];

    // Adicionar depend√™ncias TypeScript se necess√°rio
    if (this.isTypeScript) {
      devDependencies.push('typescript-eslint@^8.42.0', '@types/node@^22.2.0');
    }

    const cmd = `${this.packageManager} add -D ${devDependencies.join(' ')}`;

    try {
      execSync(cmd, { stdio: 'inherit' });
      console.log('‚úÖ Depend√™ncias instaladas com sucesso!\n');
    } catch (error) {
      throw new Error(`Falha ao instalar depend√™ncias: ${error}`);
    }
  }

  async setupHusky() {
    console.log('üêï Configurando Husky...');

    try {
      // Inicializar Husky
      execSync(`${this.packageManager} exec husky init`, { stdio: 'inherit' });

      // Criar hook pre-commit
      writeFileSync(
        '.husky/pre-commit',
        `#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

pnpm exec lint-staged
`
      );

      // Criar hook commit-msg
      writeFileSync(
        '.husky/commit-msg',
        `#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

pnpm exec commitlint --edit \${1}
`
      );

      console.log('‚úÖ Husky configurado com sucesso!\n');
    } catch (error) {
      throw new Error(`Falha ao configurar Husky: ${error}`);
    }
  }

  async createConfigFiles() {
    console.log('üìù Criando arquivos de configura√ß√£o...');

    // CommitLint config
    const commitlintConfig = `module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      [
        'feat',     // Nova funcionalidade
        'fix',      // Corre√ß√£o de bug
        'docs',     // Documenta√ß√£o
        'style',    // Formata√ß√£o, missing semi colons, etc
        'refactor', // Refatora√ß√£o de c√≥digo
        'test',     // Adi√ß√£o ou corre√ß√£o de testes
        'chore',    // Mudan√ßas no processo de build ou ferramentas
        'perf',     // Melhoria de performance
        'ci',       // Mudan√ßas no CI
        'build',    // Mudan√ßas no sistema de build
        'revert'    // Revers√£o de commit
      ]
    ],
    'subject-case': [2, 'never', ['start-case', 'pascal-case', 'upper-case']],
    'subject-max-length': [2, 'always', 72],
    'body-max-line-length': [2, 'always', 100]
  }
};`;
    writeFileSync('commitlint.config.js', commitlintConfig);

    // Prettier config
    const prettierConfig = `{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "endOfLine": "lf"
}`;
    writeFileSync('.prettierrc', prettierConfig);

    // ESLint config
    const eslintConfig = this.generateESLintConfig();
    writeFileSync('eslint.config.mjs', eslintConfig);

    // Prettier ignore
    const prettierIgnore = `# Dependencies
node_modules/
dist/
build/
coverage/

# Logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# OS generated files
.DS_Store
Thumbs.db

# IDE
.vscode/
.idea/
*.swp
*.swo

# Temporary files
*.tmp
*.temp
`;
    writeFileSync('.prettierignore', prettierIgnore);

    console.log('‚úÖ Arquivos de configura√ß√£o criados!\n');
  }

  generateESLintConfig() {
    const baseConfig = `import js from '@eslint/js';
import globals from 'globals';
import eslintPluginPrettier from 'eslint-plugin-prettier';
import eslintConfigPrettier from 'eslint-config-prettier';
import security from 'eslint-plugin-security';`;

    const tsConfig = this.isTypeScript
      ? `
import tseslint from 'typescript-eslint';`
      : '';

    const configArray = this.isTypeScript
      ? `
export default tseslint.config(
  js.configs.recommended,
  ...tseslint.configs.recommended,
  eslintConfigPrettier,
  security.configs.recommended,`
      : `
export default [
  js.configs.recommended,
  eslintConfigPrettier,
  security.configs.recommended,`;

    return `${baseConfig}${tsConfig}

${configArray}
  {
    languageOptions: {
      globals: {
        ...globals.node,
        ...globals.es2021,
      },
      ecmaVersion: 2021,
      sourceType: 'module',
    },
    plugins: {
      prettier: eslintPluginPrettier,
    },
    rules: {
      'prettier/prettier': 'error',
      'no-console': 'warn',
      'no-unused-vars': 'error',
      'prefer-const': 'error',
      'no-var': 'error',
    },
  },
  {
    ignores: ['node_modules/', 'dist/', 'build/', 'coverage/'],
  },
${this.isTypeScript ? ');' : '];'}`;
  }

  async updatePackageJson() {
    console.log('üìÑ Atualizando package.json...');

    const packageJsonPath = join(this.rootDir, 'package.json');
    const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf8'));

    // Adicionar scripts
    if (!packageJson.scripts) packageJson.scripts = {};

    packageJson.scripts = {
      ...packageJson.scripts,
      lint: 'eslint . --fix',
      format: 'prettier --write .',
      'format:check': 'prettier --check .',
      commit: 'cz',
      changeset: 'changeset',
      'changeset:version': 'changeset version',
      'changeset:publish': 'changeset publish',
      validate: 'npm run lint && npm run format:check',
      prepare: 'husky',
    };

    // Configurar Commitizen
    packageJson.config = {
      ...packageJson.config,
      commitizen: {
        path: 'cz-conventional-changelog',
      },
    };

    // Configurar lint-staged
    packageJson['lint-staged'] = {
      '*.{js,jsx,ts,tsx,mjs}': ['eslint --fix', 'prettier --write'],
      '*.{json,css,scss,md,yml,yaml}': ['prettier --write'],
    };

    writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2));
    console.log('‚úÖ package.json atualizado!\n');
  }

  async setupChangesets() {
    console.log('üì¶ Configurando Changesets...');

    try {
      if (!existsSync('.changeset')) {
        mkdirSync('.changeset');
      }

      // Configura√ß√£o do Changesets
      const changesetConfig = `{
  "$schema": "https://unpkg.com/@changesets/config@3.0.0/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [],
  "access": "restricted",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}`;

      writeFileSync('.changeset/config.json', changesetConfig);
      console.log('‚úÖ Changesets configurado!\n');
    } catch (error) {
      throw new Error(`Falha ao configurar Changesets: ${error}`);
    }
  }

  async installCopilotProject() {
    console.log('ü§ñ Instalando GitHub Copilot Project...');

    try {
      const cmd = `${this.packageManager} add @arthurcorreadev/copilot-chat-integration`;
      execSync(cmd, { stdio: 'inherit' });
      console.log('‚úÖ Instala√ß√£o conclu√≠da com sucesso!');
    } catch (error) {
      console.error(
        '‚ö†Ô∏è Falha ao instalar @arthurcorreadev/copilot-chat-integration:',
        error instanceof Error ? error.message : String(error)
      );
    }
  }

  async showCompletionMessage() {
    console.log('üéâ Configura√ß√£o conclu√≠da com sucesso!\n');
    console.log('üìã Comandos dispon√≠veis:');
    console.log(`   ${this.packageManager} run lint          # Verificar e corrigir c√≥digo`);
    console.log(`   ${this.packageManager} run format        # Formatar c√≥digo`);
    console.log(`   ${this.packageManager} run commit        # Fazer commit interativo`);
    console.log(`   ${this.packageManager} run changeset     # Criar changeset para release`);
    console.log(`   ${this.packageManager} run validate      # Validar c√≥digo completo\n`);

    console.log('üìù Pr√≥ximos passos:');
    console.log('   1. git add .');
    console.log(`   2. ${this.packageManager} run commit`);
    console.log(`   3. ${this.packageManager} run changeset\n`);

    console.log('üîó Arquivos criados:');
    console.log('   ‚úÖ .husky/ (hooks do Git)');
    console.log('   ‚úÖ commitlint.config.js');
    console.log('   ‚úÖ .prettierrc');
    console.log('   ‚úÖ eslint.config.mjs');
    console.log('   ‚úÖ .changeset/config.json');
    console.log('   ‚úÖ .github/ (configura√ß√£o do Copilot)');
  }
}

// Verificar argumentos
const args = process.argv.slice(2);
const help = args.includes('--help') || args.includes('-h');

if (help) {
  console.log(`
üöÄ Configurador de Padroniza√ß√£o de Projetos

Usage:
  node setup-project-standards.js [options]

Options:
  --help, -h     Mostrar esta mensagem

Este script configura:
  üêï Husky (Git hooks)
  üìù Commitlint (Padroniza√ß√£o de commits)
  üíÖ Prettier (Formata√ß√£o de c√≥digo)
  üîç ESLint (Qualidade de c√≥digo)
  üì¶ Changesets (Versionamento sem√¢ntico)
  ü§ñ GitHub Copilot (Assistente de c√≥digo)
  üéØ Commitizen (Commits interativos)

Compat√≠vel com:
  üì¶ npm, pnpm, yarn
  üîß NestJS, Next.js, Nuxt.js, Vite, Node.js
  üìò JavaScript e TypeScript
`);
  process.exit(0);
}

// Executar instala√ß√£o
const installer = new ProjectStandardsInstaller();
installer.install();
